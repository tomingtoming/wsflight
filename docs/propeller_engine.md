# プロペラエンジンモデルの実装

## 概要

YSFLIGHTの`fsrealprop.cpp`を参考にして、より高度なプロペラエンジンモデルを実装しました。この文書では、実装されたプロペラエンジンモデルの詳細と、YSFLIGHTからの知見について説明します。

## YSFLIGHTのプロペラエンジンモデル

YSFLIGHTのプロペラエンジンモデル（`fsrealprop.cpp`）は、以下の特徴を持っています：

1. **個々のブレードの物理シミュレーション**：
   - 各ブレードを独立した物理オブジェクトとして扱い、空気力学特性をシミュレーション
   - ブレードごとの揚力と抗力を計算
   - ブレードの回転角度と迎え角に基づく力の計算

2. **可変ピッチプロペラの実装**：
   - ガバナー機構による自動ピッチ調整
   - 目標RPMに基づくピッチ角の制御

3. **詳細なトルク計算**：
   - エンジンブレーキトルクモデル
   - ブレードにかかる空気力学的トルク

4. **エネルギー保存に基づく物理計算**：
   - エンジン出力をエネルギーとして計算
   - 運動エネルギーとエンジン出力の関係による回転速度の計算

## wsflight への実装

YSFLIGHTのモデルを参考に、TypeScriptで以下の機能を実装しました：

1. **PropellerBlade インターフェース**：
   - ブレードの空力特性（揚力係数、抗力係数）
   - ブレードの物理特性（重量、重心位置、揚力中心）
   - ブレードの状態（角度、ピッチ角）
   - ブレードにかかる力とトルク

2. **ブレード力学計算**：
   - `calculateBladeForcesAndTorque`メソッドで各ブレードの力とトルクを計算
   - 空気密度、相対速度、ブレード角度、ピッチ角に基づく計算
   - 揚力ベクトルと抗力ベクトルの3D空間での計算

3. **プロペラピッチ制御**：
   - `controlPropellerPitch`メソッドでピッチ角の自動調整
   - 目標回転速度と現在の回転速度の差に基づく制御

4. **エンジンRPM更新の改良**：
   - エンジンブレーキトルクモデルを継承
   - エネルギー保存法則に基づく回転速度計算
   - エネルギー入力（馬力）とトルクによるエネルギー損失の考慮

## 実装上の考慮点

1. **下位互換性**：
   - 従来のシンプルなエンジンモデルも引き続きサポート
   - プロペラブレードモデルが無効な場合は、従来の計算方法にフォールバック

2. **数値安定性**：
   - 極端に小さい値や分母がゼロになる可能性がある計算での対策
   - 異常値が発生した場合の適切な処理

3. **最適化**：
   - 必要な計算のみを行うための早期リターン
   - ベクトル計算のヘルパーメソッド化による再利用性の向上

## YSFLIGHTからの主な知見

1. **エンジン出力を馬力（ジュール/秒）として扱う**：
   - スロットル位置に応じたエネルギー出力を計算
   - エネルギーからトルクと回転速度への変換

2. **プロペラブレードモデルのパラメータ化**：
   - 揚力係数と抗力係数の二次曲線による近似
   - ブレード面積、重量、重心位置などの物理パラメータ

3. **ピッチ制御メカニズム**：
   - プロポーショナル制御によるピッチ角調整
   - 目標回転速度とのずれに比例した調整量

4. **エンジンブレーキモデル**：
   - 過回転時のブレーキトルク
   - スロットル位置に応じた目標RPMの変化

## 今後の改善点

1. **空力モデルの精緻化**：
   - 失速挙動の改善
   - マッハ数の影響の考慮

2. **プロペラの視覚的表現**：
   - ブレード回転の3Dモデル化
   - 回転エフェクトの追加

3. **音響モデル**：
   - 回転速度に応じたプロペラ音の変化
   - エンジン音の実装

4. **熱モデル**：
   - エンジン温度のシミュレーション
   - オーバーヒートと性能への影響

5. **燃料消費モデル**：
   - 馬力出力に応じた燃料消費計算
   - 燃料残量と性能への影響