# wsflight 開発計画 (v1.1)

YSFLIGHTのようなフライトシミュレーターをWebブラウザ上で再現するプロジェクトです。
このプロジェクトは、Three.jsを使用して3Dグラフィックスを描画し、
DenoとSocket.ioを使用してリアルタイム通信を実現します。
参考にするためのYSFLIGHTのソースコードはリポジトリルートの /YSFLIGHT/ に格納されています。

YSFLIGHTのソースコードから得た知見は常にリポジトリの /docs/ にドキュメントとして保存し、
プロジェクトの進捗状況や開発計画はこの .clinerules に記載します。

## プロジェクト構造

```
/wsflight
├── docs/ - ドキュメント
│   ├── flight_physics.md - 飛行物理モデルの解説
│   └── propeller_engine.md - プロペラエンジンモデルの詳細
├── public/ - フロントエンド
│   ├── index.html - メインHTML
│   ├── scripts/ - クライアントサイドスクリプト
│   │   ├── main.ts - エントリーポイント
│   │   └── physics/ - 物理計算モジュール
│   └── styles/ - CSS
│       └── main.css - メインスタイル
├── scripts/ - ビルドスクリプト
│   ├── build.ts - ビルドプロセス
│   └── dev.ts - 開発サーバー
├── src/ - サーバーサイドソース
│   ├── main.ts - サーバーエントリーポイント
│   └── physics/ - 物理計算モジュール
│       ├── Aircraft.ts - 航空機クラス
│       └── types.ts - 型定義
├── YSFLIGHT/ - 参照用YSFLIGHTソースコード
├── .clinerules - プロジェクト計画と進捗
├── .gitignore
├── deno.json - Deno設定
└── README.md
```

## コーディング規約

- TypeScriptを使用し、厳格な型チェックを有効にする
- Three.jsとDenoの基本的な連携を優先する
- コードの品質を保つため、以下のツールを使用する：
  - ESLint: コード品質とスタイルの一貫性を確保
  - Prettier: コードフォーマットの自動化
- インターフェースを活用し、疎結合な設計を心がける
- 物理計算などの重要な機能は必ずユニットテストを作成する
- コミットメッセージは具体的かつ明確に記述する
- ドキュメントは日本語で作成し、コードコメントは英語で記述する

## 開発環境

- ビルド: `deno task build`
- 開発サーバー起動: `deno task dev`
- サーバーURL: http://localhost:8000
- 必要なツール:
  - Deno 1.x以上
  - モダンブラウザ（Chrome, Firefox, Safari, Edge）

## 機能実装チェックリスト

### 3Dレンダリングとグラフィックス (Three.js)
- [x] Three.jsの基本セットアップ
- [x] カメラとライティングの設定
- [x] 基本的な地形の実装
- [x] 1機の航空機モデルの設計と実装
- [ ] 飛行機のテクスチャと詳細設計
- [ ] 天候システム（晴れ/曇り）の実装

### 物理エンジンと飛行ダイナミクス
- [x] 飛行物理モデルの実装
- [x] 重力と空気抵抗のシミュレーション
- [x] エンジン出力と推力の計算
- [x] 舵の効きと航空力学の実装
- [x] 衝突判定システムの実装（地面のみ）
- [ ] 失速時の挙動改善（迎え角に応じた揚力の非線形挙動）
- [ ] 風の影響のシミュレーション

### ユーザーインターフェースと操作
- [x] キーボード入力ハンドリングの実装
- [x] 操縦系統（エルロン、エレベーター、ラダー、スロットル）の実装
- [x] HUD（ヘッドアップディスプレイ）の設計と実装
- [ ] コックピット表示の充実（計器類の実装）
- [ ] メニュー画面と設定画面の実装
- [ ] チュートリアルの作成

### バックエンド (Deno)
- [x] Denoサーバーの初期設定
- [x] 静的ファイル配信の実装
- [ ] APIエンドポイントの設計
- [x] エラーハンドリングとロギング
- [ ] パフォーマンス最適化

### リアルタイム通信 (Socket.io)
- [ ] Socket.io接続の基本設定
- [ ] クライアント・サーバー間通信プロトコルの設計
- [ ] 状態同期メカニズムの実装
- [ ] 接続エラー処理とリカバリー
- [ ] レイテンシー最適化

## 既知の課題と対応策

### 技術的課題
1. **404エラー**: ブラウザコンソールに404エラーが表示される
   - 対応策: リソースパスの確認と修正が必要

2. **高度な航空力学効果の欠如**: 失速時の挙動など、より複雑な航空力学効果が未実装
   - 対応策: YSFLIGHTのfsairplaneproperty.cppを参考に実装予定

3. **コードの疎結合化**: 一部のコンポーネント間の結合度が高い
   - 対応策: インターフェースを活用したリファクタリングを計画中

## テスト計画（優先順位順）

1. **物理計算モジュールの単体テスト**
   - Aircraft.tsの各メソッドのテスト
   - 大気モデル計算のテスト
   - エンジンモデル計算のテスト

2. **統合テスト**
   - フロントエンドとバックエンドの連携テスト
   - ユーザー入力から物理計算までの一連のフローテスト

3. **パフォーマンステスト**
   - フレームレート測定
   - メモリ使用量の監視
   - CPU負荷の測定

4. **クロスブラウザテスト**
   - Chrome, Firefox, Safari, Edgeでの動作確認

5. **ユーザビリティテスト**
   - 操作性の評価
   - UI/UXの改善点の特定

## 開発ロードマップ

### 短期目標（1-3ヶ月）
1. **航空機モデルの強化**
   - 失速時の挙動改善
   - フラップ、スポイラー、可変翼などの制御面の追加
   - 風の影響のシミュレーション

2. **UI/UXの改善**
   - コックピット表示の充実
   - 計器類の実装（高度計、速度計、姿勢指示器など）
   - メニュー画面と設定画面の実装

3. **テスト基盤の構築**
   - 単体テストフレームワークの導入
   - 重要なモジュールのテスト実装

### 中期目標（3-6ヶ月）
1. **自動操縦システムの実装**
   - 高度維持
   - 方向維持
   - 簡易な着陸アプローチ

2. **マルチプレイヤー基盤の構築**
   - Socket.io接続の基本設定
   - クライアント・サーバー間通信プロトコルの設計
   - 状態同期メカニズムの実装

### 長期目標（6ヶ月以上）
1. **高度なマルチプレイヤー機能**
   - 編隊飛行
   - 空戦シミュレーション

2. **環境の拡張**
   - 詳細な地形と景観
   - 天候システム（雨、雪、霧など）

## 技術的負債と最適化の機会

### 技術的負債
1. **コード構造**: 一部のコンポーネントが密結合しており、将来的な拡張性に影響する可能性
2. **エラーハンドリング**: 包括的なエラーハンドリング戦略の欠如
3. **ドキュメント**: コード内ドキュメントの不足
4. **テスト**: テスト自動化の欠如

### 最適化の機会
1. **パフォーマンス**:
   - 物理計算の最適化（WebAssemblyの活用検討）
   - レンダリングパイプラインの効率化

2. **コード品質**:
   - ESLintとPrettierの導入
   - コード規約の厳格化

3. **アーキテクチャ**:
   - モジュール間の明確な境界設定
   - 依存性注入パターンの活用

## 確認済み機能と実装状況

1. **大気モデル**
   - ✅ 高度に基づく大気密度計算 → `getAirDensity()` として実装済み
   - ✅ 高度に基づくマッハ1の速度計算 → `getMachOne()` として実装済み

2. **エンジン特性**
   - ✅ エンジンブレーキトルク → Aircraft.ts の `updateEngineRPM()` に実装済み
   - ✅ スロットルとRPMの関連付け → Aircraft.ts に実装済み
   - ✅ プロペラの詳細モデル → Aircraft.ts に `calculateBladeForcesAndTorque()`, `controlPropellerPitch()` として実装済み

3. **航空力学**
   - ✅ 揚力・抗力計算モデル
   - ✅ 舵面効果（エルロン、エレベータ、ラダー）
   - ✅ 地面衝突と摩擦
   - ⚠️ 未対応: 高度な航空力学効果（失速時の挙動など）

4. **航空機特性**
   - ✅ 基本的な状態管理（位置、姿勢、速度など）
   - ⚠️ 未対応: 詳細な航空機特性（離着陸装置、フラップ、スポイラーなど）
   - ⚠️ 未対応: 気象の影響（風、乱気流など）
   - ⚠️ 未対応: 自動操縦システム

## 操作方法

- **カメラ**: マウスドラッグでカメラ操作（Three.jsのOrbitControls）
- **航空機**:
  - ↑/↓キー: エレベータ（ピッチ制御）
  - ←/→キー: エルロン（ロール制御）
  - A/Dキー: ラダー（ヨー制御）
  - Wキー: スロットル最大
  - Sキー: スロットル最小
- **シミュレーション**:
  - スペースキー: シミュレーション開始/一時停止

## 現状の文脈 (2025/03/10)

### 最近の進捗・改善点
- **プロペラエンジンモデルの実装完了**
  - YSFLIGHTのfsrealprop.cppを参考に詳細なプロペラブレードモデルを実装
  - 個々のブレードの揚力・抗力を計算し、正確な推力とトルクを生成
  - 可変ピッチプロペラとガバナー機構（自動ピッチ調整）の実装
  - エネルギーベースのエンジン出力計算システム

- **TypeScriptへの完全移行**
  - src/physics/types.ts, public/scripts/main.ts, src/physics/Aircraft.tsのTypeScript化
  - 旧JSファイルは削除
  - ビルドプロセスで.tsファイルから.jsファイルを生成する設計

- **ドキュメント強化**
  - docs/flight_physics.mdに飛行物理モデルの解説を追加
  - docs/propeller_engine.mdにプロペラエンジンモデルの詳細ドキュメントを作成

### 次のステップ
1. 既知の404エラーの修正
2. テスト基盤の構築と重要モジュールのテスト実装
3. UI/UXの改善（特にHUDとコックピット表示）
4. 航空機モデルの強化（特に失速挙動と追加制御面）
5. 自動操縦システムの基本実装
